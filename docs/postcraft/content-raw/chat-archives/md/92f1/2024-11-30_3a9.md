# [Periodic Ping Processor with Worker Threads](https://claude.ai/chat/92f1e3a5-0db8-4155-9d14-bcdb2c02ffe8)

3a981ea2-9705-46b4-8861-005f6a7927d0

 Let me help create a Ping processor that runs a long-running process in a worker thread.



<antArtifact identifier="ping-processor" type="application/vnd.ant.code" language="javascript" title="Ping.js">
import { Worker } from 'worker_threads';
import path from 'path';
import logger from '../../utils/Logger.js';
import Processor from '../base/Processor.js';
import ns from '../../utils/ns.js';

class Ping extends Processor {
    constructor(config) {
        super(config);
        this.worker = null;
        this.pingConfig = {
            interval: this.getPropertyFromMyConfig(ns.trm.interval) || 5000,
            count: this.getPropertyFromMyConfig(ns.trm.count) || 0,
            payload: this.getPropertyFromMyConfig(ns.trm.payload) || 'ping'
        };
    }

    async process(message) {
        try {
            this.worker = new Worker(
                path.join(process.cwd(), 'src/processors/flow/PingWorker.js')
            );

            this.worker.on('message', (msg) => {
                switch (msg.type) {
                    case 'ping':
                        this.emit('message', {
                            ...message,
                            ping: {
                                count: msg.count,
                                timestamp: msg.timestamp,
                                payload: msg.payload
                            }
                        });
                        break;
                    case 'complete':
                        this.emit('message', { ...message, pingComplete: true });
                        break;
                    case 'error':
                        logger.error(`Ping error: ${msg.error}`);
                        this.emit('error', new Error(msg.error));
                        break;
                }
            });

            this.worker.on('error', (error) => {
                logger.error(`Worker error: ${error}`);
                this.emit('error', error);
            });

            this.worker.postMessage({
                type: 'start',
                config: this.pingConfig
            });

            return new Promise((resolve) => {
                this.worker.on('exit', () => {
                    resolve(message);
                });
            });

        } catch (error) {
            logger.error(`Failed to start ping processor: ${error}`);
            throw error;
        }
    }

    async shutdown() {
        if (this.worker) {
            this.worker.postMessage({ type: 'stop' });
        }
    }
}

export default Ping;
</antArtifact>

<antArtifact identifier="ping-worker" type="application/vnd.ant.code" language="javascript" title="PingWorker.js">
import { parentPort } from 'worker_threads';
import logger from '../../utils/Logger.js';

class PingWorker {
    constructor() {
        this.interval = null;
        this.count = 0;
        this.currentCount = 0;
        this.payload = null;
        this.setupMessageHandling();
    }

    setupMessageHandling() {
        parentPort.on('message', (message) => {
            switch (message.type) {
                case 'start':
                    this.start(message.config);
                    break;
                case 'stop':
                    this.stop();
                    break;
                default:
                    logger.warn(`Unknown message type: ${message.type}`);
            }
        });
    }

    start(config) {
        try {
            const { interval, count, payload } = config;
            this.count = count;
            this.payload = payload;
            
            this.interval = setInterval(() => {
                this.currentCount++;
                
                parentPort.postMessage({
                    type: 'ping',
                    count: this.currentCount,
                    timestamp: Date.now(),
                    payload: this.payload
                });

                if (this.count > 0 && this.currentCount >= this.count) {
                    this.stop();
                    parentPort.postMessage({ type: 'complete' });
                }
            }, interval);

        } catch (error) {
            parentPort.postMessage({
                type: 'error',
                error: error.message
            });
        }
    }

    stop() {
        if (this.interval) {
            clearInterval(this.interval);
            this.interval = null;
        }
        process.exit(0);
    }
}

const worker = new PingWorker();
</antArtifact>

This implementation:

1. The Ping processor sets up a worker thread that emits periodic messages
2. Configurable interval, count (0 for infinite), and payload
3. Proper error handling and cleanup
4. Uses same worker thread pattern as HttpServer

To use this in a transmission:

```turtle
:ping a :Ping ;
    trm:configKey :pingConfig .

t:pingConfig a trm:ServiceConfig ;
    trm:interval 5000 ;  # 5 seconds
    trm:count 10 ;       # Stop after 10 pings (0 for infinite)
    trm:payload "ping" . # Custom payload string
```

q1: Would you like to see example usage in a test application?
q2: Should I add any additional configuration options?
q3: Would you like to see the processor factory implementation? 
q4: Should I add any additional error handling or recovery mechanisms?

---

* **sourceFile** : /home/danny/github-danny/hyperdata/docs/chat-archives/data-2025-01-25-12-45-58/conversations.json
* **appName** : claude-json-converter
* **appPath** : claude-json-converter
* **subtask** : [undefined]
* **rootDir** : /home/danny/github-danny/transmissions/src/applications/claude-json-converter
* **dataDir** : /home/danny/github-danny/transmissions/src/applications/claude-json-converter/data
* **targetPath** : /home/danny/github-danny/transmissions/src/applications/claude-json-converter/data
* **tags** : ccc10.ccc20.ccc30.ccc40.ccc50
* **done** : [undefined]
* **meta** : {
  "conv_uuid": "92f1e3a5-0db8-4155-9d14-bcdb2c02ffe8",
  "conv_name": "Periodic Ping Processor with Worker Threads",
  "updated_at": "2024-12-01T15:23:34.992302Z"
}
* **filepath** : /home/danny/github-danny/hyperdata/docs/postcraft/content-raw/chat-archives/md/92f1/2024-11-30_3a9.md