# [Testing HTTP Server Shutdown in Jasmine](https://claude.ai/chat/f9314c50-48b6-4b6d-80e9-1a19c21f8c0b)

9a2bc5f7-f6f8-4416-8d2f-9523b51a1c46

 <antArtifact identifier="shutdown-tests" type="application/vnd.ant.code" language="javascript" title="ShutdownService Tests">
import { expect } from 'chai';
import express from 'express';
import ShutdownService from '../../src/processors/http/services/ShutdownService.js';

describe('ShutdownService', () => {
    let app;
    let shutdownService;
    let shutdownCalled = false;

    beforeEach(() => {
        app = express();
        shutdownService = new ShutdownService();
        shutdownService.setupMiddleware(app);
        shutdownService.setupEndpoints(app, () => { shutdownCalled = true; });
    });

    it('should reject requests without auth', (done) => {
        const mockReq = { headers: {} };
        const mockRes = {
            setHeader: jasmine.createSpy('setHeader'),
            status: function(code) {
                expect(code).toBe(401);
                return { send: function() {} };
            }
        };
        
        app._router.handle(mockReq, mockRes, () => {});
        expect(mockRes.setHeader).toHaveBeenCalledWith('WWW-Authenticate', 'Basic');
        done();
    });

    it('should accept valid credentials', (done) => {
        const credentials = Buffer.from(`${shutdownService.username}:${shutdownService.password}`).toString('base64');
        const mockReq = {
            headers: { 
                authorization: `Basic ${credentials}` 
            }
        };
        const mockRes = {
            status: jasmine.createSpy('status'),
            send: jasmine.createSpy('send')
        };
        const nextSpy = jasmine.createSpy('next');

        app._router.handle(mockReq, mockRes, nextSpy);
        expect(nextSpy).toHaveBeenCalled();
        done();
    });
});
</antArtifact>

<antArtifact identifier="shutdown-client" type="application/vnd.ant.code" language="javascript" title="Client Implementation">
async function shutdownServer(baseUrl, username, password) {
    const credentials = Buffer.from(`${username}:${password}`).toString('base64');
    
    try {
        const response = await fetch(`${baseUrl}/admin/shutdown`, {
            method: 'POST',
            headers: {
                'Authorization': `Basic ${credentials}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Shutdown failed: ${response.statusText}`);
        }
        
        return await response.text();
    } catch (error) {
        console.error('Shutdown error:', error);
        throw error;
    }
}

// Usage example:
try {
    const baseUrl = 'http://localhost:4000';
    const response = await fetch(`${baseUrl}/admin/credentials`);
    const { username, password } = await response.json();
    await shutdownServer(baseUrl, username, password);
} catch (error) {
    console.error('Error:', error);
}
</antArtifact>

---

* **sourceFile** : /home/danny/github-danny/hyperdata/docs/chat-archives/data-2025-01-25-12-45-58/conversations.json
* **appName** : claude-json-converter
* **appPath** : claude-json-converter
* **subtask** : [undefined]
* **rootDir** : /home/danny/github-danny/transmissions/src/applications/claude-json-converter
* **dataDir** : /home/danny/github-danny/transmissions/src/applications/claude-json-converter/data
* **targetPath** : /home/danny/github-danny/transmissions/src/applications/claude-json-converter/data
* **tags** : ccc10.ccc20.ccc30.ccc40.ccc50
* **done** : [undefined]
* **meta** : {
  "conv_uuid": "f9314c50-48b6-4b6d-80e9-1a19c21f8c0b",
  "conv_name": "Testing HTTP Server Shutdown in Jasmine",
  "updated_at": "2024-11-30T12:26:05.211730Z"
}
* **filepath** : /home/danny/github-danny/hyperdata/docs/postcraft/content-raw/chat-archives/md/f931/2024-11-30_9a2.md