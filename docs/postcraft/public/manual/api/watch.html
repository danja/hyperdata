<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="stylesheet" href="/css/fonts.css" type="text/css"/>
        <link rel="stylesheet" href="/css/grid-columns.css" type="text/css"/>
        <link rel="stylesheet" href="/css/style.css" type="text/css"/>
        <title>File Watching API</title>
    </head>
    <!-- POST PAGE TEMPLATE -->
    <body>
    <strong></strong><em></em>
        <header id="entry-header">
            <h1 class="post-title h-cinzel">
                
            </h1>
        </header>
        <!-- ARTICLE CONTENT -->

<article class="post-content">
    <h1>File Watching API</h1>
<p>The Transmissions file watching system provides automatic processing of content changes through continuous monitoring of specified directories.</p>
<h2>Overview</h2>
<p>The watch system monitors multiple directory sets and executes sequences of Transmissions apps when files change. This enables automated content processing workflows, particularly useful for blog generation and content management systems.</p>
<h2>Configuration</h2>
<h3>Watch Configuration File</h3>
<p>The watch system uses a JSON configuration file (<code>src/api/watch/watch-config.json</code>) that defines watch sets:</p>
<pre><code class="language-json">[
    {
        &quot;name&quot;: &quot;postcraft-render&quot;,
        &quot;dirs&quot;: [
            &quot;~/sites/danny.ayers.name/postcraft&quot;,
            &quot;~/hyperdata/hyperdata/docs/postcraft&quot;,
            &quot;~/hyperdata/transmissions/docs/postcraft&quot;,
            &quot;~/hyperdata/semem/docs/postcraft&quot;
        ],
        &quot;apps&quot;: [
            &quot;md-to-sparqlstore&quot;,
            &quot;sparqlstore-to-html&quot;,
            &quot;sparqlstore-to-site-indexes ~/sites/danny.ayers.name/postcraft&quot;
        ]
    }
]
</code></pre>
<h3>Configuration Structure</h3>
<p>Each watch set contains:</p>
<ul>
<li><strong><code>name</code></strong> - Unique identifier for the watch set</li>
<li><strong><code>dirs</code></strong> - Array of directories to monitor (supports <code>~/</code> expansion)</li>
<li><strong><code>apps</code></strong> - Array of Transmissions apps to execute in sequence</li>
<li><strong><code>watchEvents</code></strong> - Array of file system events to watch for (optional, defaults to <code>[&quot;change&quot;, &quot;rename&quot;]</code>)</li>
</ul>
<h3>App Configuration Options</h3>
<p>App entries in the <code>apps</code> array support two formats:</p>
<h4>Simple Format</h4>
<pre><code class="language-json">&quot;apps&quot;: [&quot;md-to-sparqlstore&quot;]
</code></pre>
<p>Uses default behavior: passes change information via <code>-m</code> flag plus the watch directory as target.</p>
<h4>With Arguments Format</h4>
<pre><code class="language-json">&quot;apps&quot;: [&quot;sparqlstore-to-site-indexes ~/sites/danny.ayers.name/postcraft&quot;]
</code></pre>
<p>When arguments follow the app name, they <strong>override</strong> the default behavior:</p>
<ul>
<li>No change information (<code>-m</code> flag) is passed</li>
<li>No watch directory is passed as target</li>
<li>Only the specified arguments are used</li>
<li>Tilde paths (<code>~/</code>) are automatically expanded to absolute paths</li>
</ul>
<p>This allows precise control over how each app is invoked.</p>
<h3>Event Filtering Options</h3>
<p>The <code>watchEvents</code> array allows you to control which file system events trigger app execution:</p>
<h4>Supported Events</h4>
<ul>
<li><strong><code>change</code></strong> - File content modification (save operations)</li>
<li><strong><code>rename</code></strong> - File creation, deletion, or rename operations</li>
</ul>
<h4>Examples</h4>
<pre><code class="language-json">{
    &quot;name&quot;: &quot;content-only&quot;,
    &quot;dirs&quot;: [&quot;~/content&quot;],
    &quot;apps&quot;: [&quot;process-content&quot;],
    &quot;watchEvents&quot;: [&quot;change&quot;]
}
</code></pre>
<p>Only triggers on file saves/modifications, ignoring file creation or deletion.</p>
<pre><code class="language-json">{
    &quot;name&quot;: &quot;creation-only&quot;, 
    &quot;dirs&quot;: [&quot;~/uploads&quot;],
    &quot;apps&quot;: [&quot;process-new-files&quot;],
    &quot;watchEvents&quot;: [&quot;rename&quot;]
}
</code></pre>
<p>Only triggers on file creation, deletion, or rename operations.</p>
<pre><code class="language-json">{
    &quot;name&quot;: &quot;all-events&quot;,
    &quot;dirs&quot;: [&quot;~/docs&quot;],
    &quot;apps&quot;: [&quot;sync-docs&quot;]
}
</code></pre>
<p>Triggers on both change and rename events (default behavior when <code>watchEvents</code> is omitted).</p>
<h2>Command Line Interface</h2>
<h3>Basic Usage</h3>
<pre><code class="language-bash"># Start watching with default configuration
./trans watch

# Use custom configuration file
./trans watch /path/to/custom-config.json

# Show help
./trans watch --help
</code></pre>
<h3>Options</h3>
<ul>
<li><code>--debounce=&lt;ms&gt;</code> - Debounce delay in milliseconds (default: 1000)</li>
<li><code>--trans-path=&lt;path&gt;</code> - Path to trans executable (auto-detected by default)</li>
</ul>
<h2>How It Works</h2>
<h3>File Monitoring</h3>
<ol>
<li><strong>Recursive Watching</strong> - Monitors all files and subdirectories within specified paths</li>
<li><strong>Change Detection</strong> - Detects file modifications, creations, and deletions</li>
<li><strong>Debouncing</strong> - Groups rapid changes to prevent excessive processing</li>
<li><strong>Filtering</strong> - Excludes common non-content files (<code>.git/</code>, <code>node_modules/</code>, etc.)</li>
</ol>
<h3>App Execution</h3>
<p>When a file change is detected:</p>
<ol>
<li><strong>Debounce Timer</strong> - Waits for the configured delay to group related changes</li>
<li><strong>Change Info Collection</strong> - Gathers details about the changed file (path, timestamp, event type)</li>
<li><strong>Sequential Execution</strong> - Runs each app in the specified order for all directories</li>
<li><strong>File Context Passing</strong> - Sends change information to apps via <code>-m</code> flag as JSON</li>
<li><strong>Process Monitoring</strong> - Captures stdout/stderr and reports success/failure</li>
<li><strong>Error Handling</strong> - Logs failures but continues processing other apps</li>
</ol>
<h3>Example Execution Flow</h3>
<p>For a change to <code>content/raw/manual/api/watch.md</code>, the system executes:</p>
<pre><code class="language-bash"># Apps without arguments receive change info and watch directory
./trans md-to-sparqlstore -m &#39;{&quot;eventType&quot;:&quot;change&quot;,&quot;path&quot;:&quot;content/raw/manual/api/watch.md&quot;,&quot;fullPath&quot;:&quot;/home/danny/sites/danny.ayers.name/postcraft/content/raw/manual/api/watch.md&quot;,&quot;watchDir&quot;:&quot;/home/danny/sites/danny.ayers.name/postcraft&quot;,&quot;timestamp&quot;:&quot;2025-08-09T12:00:00.000Z&quot;}&#39; ~/sites/danny.ayers.name/postcraft
./trans sparqlstore-to-html -m &#39;{&quot;eventType&quot;:&quot;change&quot;,&quot;path&quot;:&quot;content/raw/manual/api/watch.md&quot;,&quot;fullPath&quot;:&quot;/home/danny/sites/danny.ayers.name/postcraft/content/raw/manual/api/watch.md&quot;,&quot;watchDir&quot;:&quot;/home/danny/sites/danny.ayers.name/postcraft&quot;,&quot;timestamp&quot;:&quot;2025-08-09T12:00:00.000Z&quot;}&#39; ~/sites/danny.ayers.name/postcraft  

# Apps with arguments use only those arguments (no change info, no default target)  
./trans sparqlstore-to-site-indexes ~/sites/danny.ayers.name/postcraft
# ... continues for all directories in the watch set
</code></pre>
<h3>Change Information Format</h3>
<p>The JSON message passed via <code>-m</code> flag contains:</p>
<ul>
<li><strong><code>eventType</code></strong> - Type of file system event (<code>change</code>, <code>rename</code>, etc.)</li>
<li><strong><code>path</code></strong> - Relative path from the watch directory to the changed file</li>
<li><strong><code>fullPath</code></strong> - Complete absolute path to the changed file</li>
<li><strong><code>watchDir</code></strong> - The watch directory that detected the change</li>
<li><strong><code>timestamp</code></strong> - ISO timestamp of when the change was detected</li>
</ul>
<h2>Programming Interface</h2>
<h3>Watch Class</h3>
<pre><code class="language-javascript">import Watch from &#39;./src/api/watch/Watch.js&#39;

const watcher = new Watch(configPath, options)
await watcher.start()
</code></pre>
<h4>Constructor Options</h4>
<ul>
<li><code>configPath</code> - Path to watch configuration file (optional)</li>
<li><code>options.debounceMs</code> - Debounce delay in milliseconds</li>
<li><code>options.transPath</code> - Path to trans executable</li>
<li><code>options.excludePatterns</code> - Additional file patterns to exclude</li>
</ul>
<h4>Methods</h4>
<ul>
<li><code>start()</code> - Initialize watching and begin monitoring</li>
<li><code>stop()</code> - Clean shutdown of all watchers</li>
</ul>
<h3>WatchConfig Class</h3>
<pre><code class="language-javascript">import WatchConfig from &#39;./src/api/watch/WatchConfig.js&#39;

const config = new WatchConfig(configPath)
await config.load()
const watchSets = config.getWatchSets()
</code></pre>
<h2>Use Cases</h2>
<h3>Content Management</h3>
<ul>
<li><strong>Blog Publishing</strong> - Automatically process markdown files into HTML</li>
<li><strong>Documentation</strong> - Update generated docs when source files change</li>
<li><strong>Asset Processing</strong> - Compile and optimize media files</li>
</ul>
<h3>Development Workflows</h3>
<ul>
<li><strong>Live Reload</strong> - Automatically rebuild during development</li>
<li><strong>Testing</strong> - Run tests when source code changes</li>
<li><strong>Deployment</strong> - Trigger builds and deployments</li>
</ul>
<h2>Best Practices</h2>
<h3>Configuration</h3>
<ul>
<li><strong>Specific Directories</strong> - Watch only necessary directories to minimize overhead</li>
<li><strong>Appropriate Debouncing</strong> - Balance responsiveness with system load</li>
<li><strong>Error Recovery</strong> - Design apps to handle partial failures gracefully</li>
</ul>
<h3>Performance</h3>
<ul>
<li><strong>Exclude Patterns</strong> - Add patterns for large binary files or build directories</li>
<li><strong>Resource Monitoring</strong> - Monitor system resources during heavy file activity</li>
<li><strong>Logging Levels</strong> - Use appropriate verbosity for production vs. development</li>
</ul>
<h2>Logging</h2>
<p>The watch system provides comprehensive logging to help monitor activity and troubleshoot issues.</p>
<h3>Log Files</h3>
<p>All watch system activity is logged to:</p>
<pre><code>logs/watch.log
</code></pre>
<h3>Log Format</h3>
<p>Each log entry includes:</p>
<ul>
<li><strong>Timestamp</strong> - ISO 8601 format</li>
<li><strong>Component</strong> - [WATCH] identifier</li>
<li><strong>Level</strong> - INFO, DEBUG, WARN, ERROR</li>
<li><strong>Message</strong> - Detailed event information</li>
</ul>
<p>Example log entries:</p>
<pre><code>[2025-08-08T10:52:15.123Z] [WATCH] [INFO] Starting Transmissions file watcher...
[2025-08-08T10:52:15.124Z] [WATCH] [INFO] Setting up watch set: postcraft-render
[2025-08-08T10:52:15.130Z] [WATCH] [INFO] File changed in watch set &quot;postcraft-render&quot;: content/raw/manual/api/watch.md
[2025-08-08T10:52:15.131Z] [WATCH] [INFO] Executing: ./trans md-to-sparqlstore /home/danny/sites/danny.ayers.name/postcraft
[2025-08-08T10:52:16.205Z] [WATCH] [INFO] âœ“ md-to-sparqlstore completed successfully for /home/danny/sites/danny.ayers.name/postcraft
</code></pre>
<h3>Monitoring Logs</h3>
<p>Watch log activity in real-time:</p>
<pre><code class="language-bash"># Follow the watch log
tail -f logs/watch.log

# Filter by log level
grep &quot;ERROR&quot; logs/watch.log
grep &quot;WARN&quot; logs/watch.log

# Monitor specific events
grep &quot;File changed&quot; logs/watch.log
grep &quot;Executing:&quot; logs/watch.log
grep &quot;completed successfully&quot; logs/watch.log
</code></pre>
<h3>Log Levels</h3>
<ul>
<li><strong>INFO</strong> - Normal operations (startup, file changes, app executions)</li>
<li><strong>DEBUG</strong> - Detailed information (directory watching, app output)</li>
<li><strong>WARN</strong> - Non-critical issues (missing directories, failed watchers)</li>
<li><strong>ERROR</strong> - Critical failures (app execution errors, configuration issues)</li>
</ul>
<h2>Troubleshooting</h2>
<h3>Common Issues</h3>
<p><strong>Watch not starting:</strong></p>
<ul>
<li>Check directory permissions</li>
<li>Verify configuration file syntax</li>
<li>Ensure trans executable is found</li>
<li><strong>Review logs:</strong> <code>tail logs/watch.log</code></li>
</ul>
<p><strong>Apps not executing:</strong></p>
<ul>
<li>Verify app names exist in <code>src/apps/</code></li>
<li>Check trans executable permissions</li>
<li><strong>Review logs:</strong> <code>grep &quot;ERROR&quot; logs/watch.log</code></li>
</ul>
<p><strong>High system load:</strong></p>
<ul>
<li>Increase debounce delay</li>
<li>Add exclude patterns for irrelevant files</li>
<li>Monitor watched directory sizes</li>
<li><strong>Review logs:</strong> <code>grep &quot;File changed&quot; logs/watch.log</code></li>
</ul>
<h3>Debugging</h3>
<p>Monitor watch system activity:</p>
<pre><code class="language-bash"># Real-time log monitoring
tail -f logs/watch.log

# Enable verbose console output
./trans watch --verbose

# Check recent errors
tail -50 logs/watch.log | grep &quot;ERROR&quot;
</code></pre>
<p>Check configuration loading:</p>
<pre><code class="language-javascript">const config = new WatchConfig()
await config.load()
console.log(config.getWatchSets())
</code></pre>
<h2>Testing</h2>
<p>The watch system includes comprehensive automated tests to ensure reliability and proper functionality.</p>
<h3>Running Tests</h3>
<p>Execute the complete watch system test suite:</p>
<pre><code class="language-bash"># Run all watch system tests (unit + integration)
npm test -- tests/api/watch/ tests/integration/watch/

# Run only unit tests (faster, focused on individual components)
npm test -- tests/api/watch/

# Run only integration tests (comprehensive real-world scenarios)
npm test -- tests/integration/watch/
</code></pre>
<p>The test suite includes:</p>
<ul>
<li><strong>Unit tests</strong> (45 tests) - Test individual components like WatchConfig and Watch classes</li>
<li><strong>Integration tests</strong> (14 tests) - Test complete workflows including file watching, app execution, and error handling</li>
<li><strong>Mock helpers</strong> - Simulate file changes, app execution, and timing scenarios</li>
</ul>
<p>All tests run in isolation with temporary directories and mocked system calls to ensure no impact on your development environment.</p>
<h2>Related Documentation</h2>
<ul>
<li><a href="../cli.md">Transmissions CLI Reference</a></li>
<li><a href="../apps.md">App Development Guide</a></li>
<li><a href="../config.md">Configuration Management</a></li>
</ul>

</article>
<p class="post-title h-cinzel">
    <a href="https://tensegrity.it/manual/api/watch.html">
        File Watching API
    </a>
</p> <em></em>
    </body>
</html>